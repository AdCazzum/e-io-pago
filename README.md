# XMTP Receipt Split Agent

An intelligent agent running on XMTP (Base Network) that analyzes receipt images using GPT-4o Vision API and automatically calculates bill splits for group chats.

## ğŸŒŸ Features

- **ğŸ“¸ Receipt Image Analysis**: Upload a receipt photo and get instant OCR analysis
- **ğŸ¤– GPT-4o Vision**: Advanced AI extracts items, prices, taxes, and totals
- **ğŸ’° Automatic Bill Splitting**: Calculates equal splits for all group members
- **ğŸ’¬ Natural Language Responses**: Friendly, conversational messages in English
- **ğŸ‘¥ Group Chat Support**: Works seamlessly in XMTP group conversations
- **ğŸ”’ Secure & Private**: End-to-end encrypted messaging via XMTP
- **âš¡ Fast Processing**: Quick analysis and response times
- **ğŸŒ Base Network**: Runs on Base (Ethereum L2)

## ğŸ“‹ Prerequisites

Before you begin, ensure you have:

- **Node.js v20 or higher** - [Download here](https://nodejs.org/)
- **npm** (comes with Node.js)
- **OpenAI Account** with API access - [Sign up here](https://platform.openai.com/)
- **Git** (optional, for cloning)

## ğŸš€ Quick Start

### 1. Clone or Download

```bash
git clone <your-repo-url>
cd e-io-pago
```

Or download and extract the ZIP file.

### 2. Install Dependencies

```bash
npm install
```

This will install all required packages:
- `@xmtp/agent-sdk` - XMTP messaging
- `@xmtp/content-type-remote-attachment` - Image handling
- `openai` - GPT-4o Vision API
- `ethers` - Ethereum wallet utilities
- `dotenv` - Environment configuration

### 3. Generate XMTP Keys

```bash
npm run gen:keys
```

This command will:
- Generate a new Ethereum wallet for your agent
- Create a database encryption key
- Create a `.env` file with the generated keys
- Display your agent's wallet address

**Output example:**
```
âœ… Keys generated successfully!

ğŸ” Agent Wallet Details:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Address: 0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb
Private Key: 0x...
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âš ï¸  IMPORTANT: Keep your private key secure!
```

**Save the wallet address** - you'll need it to add the agent to group chats!

### 4. Configure OpenAI API Key

Edit the `.env` file and add your OpenAI API key:

```env
OPENAI_API_KEY=sk-proj-...your-actual-key...
```

**How to get an OpenAI API key:**
1. Go to [platform.openai.com](https://platform.openai.com/)
2. Sign up or log in
3. Navigate to [API Keys](https://platform.openai.com/api-keys)
4. Click "Create new secret key"
5. Copy the key and paste it in your `.env` file

**Note:** GPT-4o Vision API requires a paid OpenAI account with credits.

### 5. Start the Agent

#### Development Mode

```bash
npm run dev
```

This starts the agent with hot-reloading using `tsx`.

#### Production Mode

```bash
npm run build
npm start
```

This compiles TypeScript to JavaScript and runs the compiled code.

### 6. Verify Agent is Running

You should see output like:

```
ğŸš€ Starting XMTP Receipt Split Agent...

ğŸ”„ Starting agent...

âœ… Agent is ready and listening for messages!

ğŸ“¬ Agent Address: 0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb
ğŸ”— Test URL: https://xmtp.chat/dm/0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb
ğŸŒ Environment: dev

ğŸ’¡ Add this agent to a group chat and send a receipt image!
```

Keep this terminal window open - the agent will continue running and logging activity.

## ğŸ“– Usage

### Testing with XMTP Chat (Development)

1. Open [xmtp.chat](https://xmtp.chat) in your browser
2. Connect your wallet
3. Create a new group chat or use an existing one
4. Add the agent's address to the group
5. Send a receipt image to the group
6. The agent will analyze it and respond with the split calculation!

### Using with Base App (Production)

1. Install the [Base mobile app](https://base.org)
2. Create or join a group chat
3. Add the agent's address
4. Send a receipt photo
5. Get instant bill split calculations!

### Example Interaction

**You:** *[Sends receipt image from dinner]*

**Agent:**
```
ğŸ“ Receipt Analysis Complete!

ğŸª Joe's Pizza Restaurant
ğŸ“… Date: 2025-01-15

Items:
  â€¢ Large Pepperoni Pizza: $24.99
  â€¢ Caesar Salad: $12.50
  â€¢ Garlic Bread: $6.99
  â€¢ Sodas (x3): $8.97

ğŸ’° Subtotal: $53.45
ğŸ§¾ Tax: $4.81
ğŸ’µ Tip: $10.00
Total: $68.26

ğŸ‘¥ Split Between 4 People:
Each person pays: $17.07 ğŸ¯

Time to settle up! ğŸ’¸
```

### Available Commands

- **`help`** - Shows usage instructions
- **`hello`** / **`hi`** - Friendly greeting
- **Send receipt image** - Analyzes and calculates split

## âš™ï¸ Configuration

### Environment Variables

Edit `.env` to configure the agent:

```env
# Required: XMTP wallet private key (generated by npm run gen:keys)
XMTP_WALLET_KEY=0x...

# Required: Database encryption key (generated by npm run gen:keys)
XMTP_DB_ENCRYPTION_KEY=abc123...

# Required: Environment ('dev' for testing, 'production' for live)
XMTP_ENV=dev

# Required: OpenAI API key
OPENAI_API_KEY=sk-proj-...

# Optional: Custom database path (default: ./data/xmtp-db)
# DB_PATH=./data/xmtp-db
```

### Development vs Production

**Development Mode (`XMTP_ENV=dev`):**
- Uses XMTP development network
- Test with [xmtp.chat](https://xmtp.chat)
- No real funds needed
- Database stored locally

**Production Mode (`XMTP_ENV=production`):**
- Uses XMTP production network on Base
- Real users on Base mobile app
- Permanent message history
- Persistent database required

## ğŸ—‚ï¸ Project Structure

```
e-io-pago/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.ts                    # Main agent implementation
â”‚   â”œâ”€â”€ types.ts                    # TypeScript interfaces
â”‚   â””â”€â”€ utils/
â”‚       â”œâ”€â”€ receipt-analyzer.ts     # GPT-4o Vision integration
â”‚       â””â”€â”€ message-formatter.ts    # Natural language responses
â”œâ”€â”€ scripts/
â”‚   â””â”€â”€ generate-keys.ts            # Key generation utility
â”œâ”€â”€ docs/
â”‚   â””â”€â”€ XMTP_RECEIPT_AGENT_DOCUMENTATION.md
â”œâ”€â”€ data/                           # XMTP database (auto-created)
â”œâ”€â”€ dist/                           # Compiled JavaScript (auto-created)
â”œâ”€â”€ .env                            # Environment variables (not in git)
â”œâ”€â”€ .env.example                    # Environment template
â”œâ”€â”€ .gitignore
â”œâ”€â”€ package.json
â”œâ”€â”€ tsconfig.json
â”œâ”€â”€ README.md                       # This file
â””â”€â”€ TESTING.md                      # Testing guide
```

## ğŸ§ª Testing

See [TESTING.md](TESTING.md) for comprehensive testing instructions including:
- Local testing procedures
- Test cases to verify
- Different client testing
- Troubleshooting guide

Quick test checklist:
- âœ… Agent starts without errors
- âœ… Responds to "help" command
- âœ… Processes receipt images (JPEG/PNG)
- âœ… Calculates splits correctly
- âœ… Works in group chats
- âœ… Handles errors gracefully

## ğŸš¢ Deployment

### Railway (Recommended)

1. Push code to GitHub
2. Go to [railway.app](https://railway.app)
3. Create new project â†’ Deploy from GitHub
4. Select your repository
5. Add environment variables:
   - `XMTP_WALLET_KEY`
   - `XMTP_DB_ENCRYPTION_KEY`
   - `XMTP_ENV=production`
   - `OPENAI_API_KEY`
6. Configure persistent volume for `/data`
7. Deploy!

See `railway.json` for configuration details.

### Other Platforms

The agent can also run on:
- **Vercel** - Serverless functions
- **Heroku** - Traditional PaaS
- **Docker** - Containerized deployment
- **VPS** - Direct server hosting

**Important for all deployments:**
- Set `XMTP_ENV=production`
- Configure persistent storage for database
- Keep environment variables secure
- Monitor logs for errors

## ğŸ”’ Security

### Best Practices

1. **Never commit `.env` file** - Contains private keys
2. **Keep wallet private key secure** - Has signing authority
3. **Rotate OpenAI API key** if compromised
4. **Use production mode** for real users
5. **Monitor API usage** - OpenAI charges per request
6. **Backup database** - Contains conversation history

### Rate Limiting

The agent includes built-in rate limiting:
- 5 second cooldown between requests per user
- 10MB max image size
- Prevents spam and abuse

## ğŸ’° Costs

### OpenAI API Pricing

- **GPT-4o Vision**: ~$0.01 per receipt analysis
- **GPT-4o Text**: ~$0.001 per response generation
- Estimated cost: **~$0.02 per receipt** processed

See [OpenAI Pricing](https://openai.com/pricing) for current rates.

### XMTP

- **Free to use** - No messaging fees
- Base Network gas fees not required for message sending
- Optional: Fund wallet for on-chain operations

## ğŸ› ï¸ Development

### Type Checking

```bash
npm run type-check
```

### Build Only

```bash
npm run build
```

### Development with Watch Mode

```bash
npm run dev
```

### Debugging

Enable verbose logging by checking console output. All operations are logged:
- Message received
- Receipt processing status
- API calls
- Errors

## ğŸ“š Documentation

- **[TESTING.md](TESTING.md)** - Complete testing guide
- **[docs/XMTP_RECEIPT_AGENT_DOCUMENTATION.md](docs/XMTP_RECEIPT_AGENT_DOCUMENTATION.md)** - Full technical documentation
- **[XMTP Docs](https://docs.xmtp.org)** - Official XMTP documentation
- **[OpenAI Vision API](https://platform.openai.com/docs/guides/vision)** - GPT-4o Vision guide
- **[Base Network](https://docs.base.org)** - Base documentation

## â“ Troubleshooting

### Agent won't start

**Error: `OPENAI_API_KEY environment variable is required`**
- Make sure `.env` file exists
- Verify `OPENAI_API_KEY` is set with a valid key

**Error: XMTP connection failed**
- Check your internet connection
- Verify `XMTP_WALLET_KEY` is correctly set
- Try regenerating keys with `npm run gen:keys`

### Receipt not processing

**"I'm having trouble reading this receipt"**
- Ensure image is clear and well-lit
- Check image is JPEG or PNG format
- Verify image size is under 10MB
- Make sure total and items are visible

**"Processing error"**
- Check OpenAI API key is valid
- Verify you have OpenAI credits
- Check internet connection
- View console logs for detailed error

### Group chat issues

**Agent not responding in group**
- Verify agent address is correct
- Make sure agent is added as group member
- Check agent is running (terminal shows activity)
- Try sending "help" command first

### Database issues

**"Database locked" error**
- Only run one instance of the agent
- Check database path permissions
- Restart the agent

## ğŸ¤ Contributing

Contributions welcome! Please:
1. Fork the repository
2. Create a feature branch
3. Make your changes
4. Test thoroughly
5. Submit a pull request

## ğŸ“„ License

MIT License - See LICENSE file for details

## ğŸ™ Acknowledgments

- **XMTP** - Decentralized messaging protocol
- **OpenAI** - GPT-4o Vision API
- **Base** - Ethereum L2 network
- **Coinbase** - Base Network support

## ğŸ“ Support

- **Issues**: Open a GitHub issue
- **XMTP Discord**: Join for community support
- **Documentation**: Check docs/ folder

## ğŸ—ºï¸ Roadmap

Future enhancements:
- [ ] Custom split ratios (not just equal splits)
- [ ] Multi-currency support
- [ ] Receipt history tracking
- [ ] Payment link generation
- [ ] Support for itemized per-person splits
- [ ] Integration with payment apps

---

**Built with â¤ï¸ using XMTP, GPT-4o, and Base Network**

For detailed technical documentation, see [docs/XMTP_RECEIPT_AGENT_DOCUMENTATION.md](docs/XMTP_RECEIPT_AGENT_DOCUMENTATION.md)
